#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

CONFIG_PATH=/var/vcap/jobs/jenkins-master/config

source /var/vcap/jobs/jenkins-master/data/properties.sh
mkdir -p /var/vcap/store/jenkins-master

if [[ "<%= p('jenkins.config.repo.enabled') %>" == "true" ]]; then
  CONFIG_PATH=/var/vcap/data/jenkins-config
  /var/vcap/jobs/jenkins-master/bin/process-configuration-repo
fi

# Install (or remove) Jenkins CasC file
if [[ -f ${CONFIG_PATH}/jenkins_config.yml ]]; then
  echo "Copying Jenkins Configuration as Code file to Jenkins home directory..."
  cp ${CONFIG_PATH}/jenkins_config.yml /var/vcap/store/jenkins-master/jenkins_config.yml

  if [[ -e /var/vcap/store/jenkins-master/config.xml ]]; then
    echo "Removing existing config.xml file..."
    rm -f /var/vcap/store/jenkins-master/config.xml
  fi
elif [[ -f /var/vcap/store/jenkins-master/jenkins_config.yml ]]; then
  rm -f /var/vcap/store/jenkins-master/jenkins_config.yml
fi

# Remove any existing groovy init scripts
if [[ -d /var/vcap/store/jenkins-master/init.groovy.d ]]; then
  rm -rf /var/vcap/store/jenkins-master/init.groovy.d
fi

# Install new groovy init scripts
if [[ -d ${CONFIG_PATH}/init.groovy.d ]]; then
    echo "Copying init.groovy.d scripts to Jenkins home directory..."
    mkdir -p /var/vcap/store/jenkins-master/init.groovy.d
    cp ${CONFIG_PATH}/init.groovy.d/*.groovy /var/vcap/store/jenkins-master/init.groovy.d/
fi

# Remove existing plugins
# TODO: Smarter logic required here to prevent download all plugins every time;
# (e.g. delete those that are not in the plugins.txt file)
if [[ -d /var/vcap/store/jenkins-master/plugins ]]; then
  rm -rf /var/vcap/store/jenkins-master/plugins
fi
mkdir -p /var/vcap/store/jenkins-master/plugins

# Handle plugins
if [[ -f ${CONFIG_PATH}/plugins.txt ]]; then
  echo "Configuring Plugins..."
  /var/vcap/jobs/jenkins-master/bin/install-plugins < ${CONFIG_PATH}/plugins.txt
fi

# add disabled plugin list
touch /var/vcap/store/jenkins-master/plugins/windows-slaves.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/subversion.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/cvs.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/ant.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/translation.jpi.disabled

# Remove any existing User Content
if [[ -d /var/vcap/store/jenkins-master/userContent ]]; then
  rm -rf /var/vcap/store/jenkins-master/userContent
fi

# Copy User Content
if [[ -d ${CONFIG_PATH}/userContent ]]; then
  echo "Copying UserContent..."
  mkdir -p /var/vcap/store/jenkins-master/userContent
  cp -R ${CONFIG_PATH}/userContent/* /var/vcap/store/jenkins-master/userContent
fi

chown vcap:vcap -R /var/vcap/store/jenkins-master
