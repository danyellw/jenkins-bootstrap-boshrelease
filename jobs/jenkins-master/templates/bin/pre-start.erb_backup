#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

source /var/vcap/jobs/jenkins-master/data/properties.sh

mkdir -p /var/vcap/store/jenkins-master
mkdir -p /var/vcap/store/jenkins-master/init.groovy.d
mkdir -p /var/vcap/store/jenkins-master/plugins

if [[ "<%= p('jenkins.config.repo.enabled') %>" == "true" ]]; then
  /var/vcap/jobs/jenkins-master/bin/process-configuration-repo
fi

# Install (or remove) Jenkins CasC file
if [[ -f /var/vcap/jobs/jenkins-master/config/jenkins_config.yml ]]; then
  echo "Copying Jenkins Configuration as Code file..."
  cp /var/vcap/jobs/jenkins-master/config/jenkins_config.yml /var/vcap/store/jenkins-master/jenkins_config.yml
elif [[ -f /var/vcap/store/jenkins-master/jenkins_config.yml ]]; then
  rm -f /var/vcap/store/jenkins-master/jenkins_config.yml
fi

# Remove any existing groovy init scripts
if [[ -d /var/vcap/store/jenkins-master/init.groovy.d ]]; then
  rm -rf /var/vcap/store/jenkins-master/init.groovy.d
fi

# Install new groovy init scripts
if [[ -d /var/vcap/jobs/jenkins-master/init.groovy.d ]]; then
    echo "Copying init.groovy.d scripts..."
    mkdir -p /var/vcap/store/jenkins-master/init.groovy.d
    cp /var/vcap/jobs/jenkins-master/init.groovy.d/*.groovy /var/vcap/store/jenkins-master/init.groovy.d/
fi

# Handle plugins
if [[ -f /var/vcap/jobs/jenkins-master/config/plugins.txt ]]; then
  echo "Configuring Plugins..."
  /var/vcap/jobs/jenkins-master/bin/install-plugins < /var/vcap/jobs/jenkins-master/config/plugins.txt
fi

# add disabled plugin list
touch /var/vcap/store/jenkins-master/plugins/windows-slaves.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/subversion.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/cvs.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/ant.jpi.disabled
touch /var/vcap/store/jenkins-master/plugins/translation.jpi.disabled

# Copy User Content
if [[ -d /var/vcap/jobs/jenkins-master/config/userContent ]]; then
    echo "Copying UserContent..."
    mkdir -p /var/vcap/store/jenkins-master/userContent
    cp -R /var/vcap/jobs/jenkins-master/config/userContent/* /var/vcap/store/jenkins-master/userContent
fi

chown vcap:vcap -R /var/vcap/store/jenkins-master
